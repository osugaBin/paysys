<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF多页在线盖章工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(90deg, #3498db, #2c3e50);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
        }

        /* 使用说明模块样式 */
        .usage-guide {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-bottom: 1px solid #dee2e6;
        }

        .usage-guide h2 {
            color: #2c3e50;
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .guide-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            max-width: 100%;
        }

        .guide-column {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #3498db;
        }

        .guide-column h3 {
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .guide-column ul {
            list-style: none;
            padding: 0;
        }

        .guide-column li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
            line-height: 1.5;
            color: #555;
        }

        .guide-column li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #27ae60;
            font-weight: bold;
        }

        .feature-highlight {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border-left-color: #27ae60;
        }

        .feature-highlight h3 {
            color: #2e7d32;
        }

        .content {
            padding: 30px;
        }

        /* VIP选择区域样式 */
        .vip-selection-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .vip-selection-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            font-size: 18px;
        }

        .vip-selection-section h3 i {
            margin-right: 10px;
        }

        /* 订单信息在二维码下方的样式 */
        .order-info-bottom {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .order-info-bottom h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            font-size: 16px;
        }

        .order-info-bottom h3 i {
            margin-right: 10px;
        }

        .vip-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .vip-option {
            flex: 1;
            cursor: pointer;
        }

        .vip-option-inner {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .vip-option-inner.selected {
            border-color: #4caf50;
            background-color: #f0f9f0;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.2);
        }

        .vip-option h4 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #333;
        }

        .vip-price {
            font-size: 24px;
            font-weight: bold;
            color: #e53935;
            margin-bottom: 5px;
        }

        .vip-duration {
            color: #666;
            margin-bottom: 10px;
        }

        .vip-tag {
            display: inline-block;
            background: #ffecb3;
            color: #ff6f00;
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
        }

        #vip-weekly .vip-tag {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .order-details {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .detail-item {
            width: 48%;
            margin-bottom: 15px;
        }

        .detail-item p {
            margin: 5px 0;
        }

        .detail-item .label {
            font-weight: 600;
            color: #7f8c8d;
        }

        .payment-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .qrcode-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }

        .qrcode-wrapper {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 20px 0;
        }

        .qrcode-item {
            text-align: center;
        }

        .qrcode-item h4 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .qrcode {
            width: 200px;
            height: 200px;
            background: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px dashed #3498db;
            border-radius: 10px;
            overflow: hidden;
        }

        .qrcode img {
            width: auto;
            height: auto;
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .amount {
            font-size: 24px;
            font-weight: 700;
            color: #e74c3c;
            margin: 15px 0;
        }

        .timer {
            color: #e74c3c;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(145deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-primary:hover {
            background: linear-gradient(145deg, #2980b9, #21618c);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.6);
        }

        .btn-trial {
            background: linear-gradient(145deg, #8bc34a, #689f38);
            color: white;
            box-shadow: 0 5px 15px rgba(139, 195, 74, 0.4);
        }

        .btn-trial:hover {
            background: linear-gradient(145deg, #689f38, #558b2f);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 195, 74, 0.6);
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
            background: #f8f9fa;
        }

        @media (max-width: 768px) {
            .guide-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .usage-guide {
                padding: 20px;
            }

            .order-details {
                flex-direction: column;
            }

            .detail-item {
                width: 100%;
            }

            .qrcode-wrapper {
                flex-direction: column;
                gap: 20px;
            }

            .qrcode {
                width: 180px;
                height: 180px;
            }

            .qrcode img {
                max-width: 90%;
                max-height: 90%;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-qrcode"></i> PDF多页在线盖章工具</h1>
            <p>请完成支付以使用服务 - 先用再付亦可</p>
        </div>

        <!-- 使用说明模块 -->
        <div class="usage-guide">
            <h2><i class="fas fa-info-circle"></i> 系统使用说明</h2>
            <div class="guide-content">
                <div class="guide-column">
                    <h3><i class="fas fa-mobile-alt"></i> 支付流程</h3>
                    <ul>
                        <li>选择VIP套餐类型（日卡/周卡）</li>
                        <li>使用支付宝或微信扫描二维码</li>
                        <li>确认支付金额并完成付款</li>
                        <li>系统自动激活VIP服务</li>
                        <li>跳转至专属服务页面</li>
                    </ul>
                </div>
                <div class="guide-column feature-highlight">
                    <h3><i class="fas fa-shield-alt"></i> 核心功能</h3>
                    <ul>
                        <li>机器码识别与设备绑定技术</li>
                        <li>单机授权使用，安全可靠</li>
                        <li>日卡(￥3.3/天)和周卡(￥9.9/7天)</li>
                        <li>精确时效管理，到期自动失效</li>
                        <li>跨设备防盗用保护机制</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="vip-selection-section">
                <h3><i class="fas fa-crown"></i> 选择VIP类型</h3>
                <div class="vip-options">
                    <div class="vip-option" id="vip-daily" onclick="selectVipType('daily')">
                        <div class="vip-option-inner">
                            <h4>日卡VIP</h4>
                            <div class="vip-price">￥3.3</div>
                            <div class="vip-duration">有效期：1天</div>
                            <div class="vip-tag">经济实惠</div>
                        </div>
                    </div>
                    <div class="vip-option" id="vip-weekly" onclick="selectVipType('weekly')">
                        <div class="vip-option-inner">
                            <h4>周卡VIP</h4>
                            <div class="vip-price">￥9.9</div>
                            <div class="vip-duration">有效期：7天</div>
                            <div class="vip-tag">推荐选择</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="payment-section">
                <div class="qrcode-container">
                    <div class="amount" id="display-amount">￥3.3</div>
                    <div class="timer" id="timer">支付剩余时间: 15:00</div>
                    
                    <div class="qrcode-wrapper">
                        <div class="qrcode-item">
                            <h4><i class="fab fa-alipay"></i> 支付宝支付</h4>
                            <div class="qrcode">
                                <img src="Ali$.jpg" alt="支付宝二维码">
                            </div>
                        </div>
                        <div class="qrcode-item">
                            <h4><i class="fab fa-weixin"></i> 微信支付</h4>
                            <div class="qrcode">
                                <img src="Wx$.jpg" alt="微信支付二维码">
                            </div>
                        </div>
                    </div>

                    <!-- 订单信息移到二维码下方 -->
                    <div class="order-info-bottom">
                        <h3><i class="fas fa-info-circle"></i> 订单信息</h3>
                        <div class="order-details">
                            <div class="detail-item">
                                <p class="label">订单编号:</p>
                                <p id="order-number">ORD-2025-1001</p>
                            </div>
                            <div class="detail-item">
                                <p class="label">设备ID:</p>
                                <p id="device-id">正在获取...</p>
                            </div>
                            <div class="detail-item">
                                <p class="label">产品名称:</p>
                                <p id="product-name">VIP会员服务（1天）</p>
                            </div>
                            <div class="detail-item">
                                <p class="label">支付金额:</p>
                                <p id="payment-amount">￥3.3</p>
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" id="simulatePaymentBtn">支付成功，进入服务</button>
                        <button class="btn btn-trial" id="simulateFailureBtn">稍后支付，我先试试</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            在线盖章系统 ｜PZYT.Ltd ｜ 技术支持: 66617886@qq.com｜调试版本 v2.1
        </div>
    </div>

    <script>
        // VIP套餐配置
        const vipTypes = {
            daily: {
                name: "VIP会员服务（1天）",
                price: "￥3.3",
                duration: "1天",
                expiryHours: 24,
            },
            weekly: {
                name: "VIP会员服务（7天）",
                price: "￥9.9",
                duration: "7天",
                expiryHours: 24 * 7,
            },
        };

        let selectedVipType = 'daily';
        let currentOrderNum = 1001;

        // 订单编号生成和D1数据库保存功能
        function generateOrderNumber() {
            const currentYear = new Date().getFullYear();
            const orderNumber = `ORD-${currentYear}-${String(currentOrderNum).padStart(4, '0')}`;
            currentOrderNum++;
            localStorage.setItem('currentOrderNum', currentOrderNum);
            return orderNumber;
        }

        // 保存订单到D1数据库
        async function saveOrderToD1(orderData) {
            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    console.log('订单已保存到D1数据库');
                    return true;
                } else {
                    throw new Error('D1数据库保存失败');
                }
            } catch (error) {
                console.log('D1数据库不可用，使用本地存储备份:', error);
                // 降级到本地存储
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                orders.push(orderData);
                localStorage.setItem('orders', JSON.stringify(orders));
                return false;
            }
        }

        // 设备指纹生成
        function generateDeviceId() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Device fingerprint', 2, 2);
            
            const fingerprint = canvas.toDataURL();
            const deviceInfo = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                screen: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                fingerprint: fingerprint
            };
            
            return btoa(JSON.stringify(deviceInfo)).substring(0, 16);
        }

        // VIP类型选择
        function selectVipType(type) {
            selectedVipType = type;
            
            // 更新UI
            document.querySelectorAll('.vip-option-inner').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`#vip-${type} .vip-option-inner`).classList.add('selected');
            
            // 更新订单信息
            const vip = vipTypes[type];
            document.getElementById('product-name').textContent = vip.name;
            document.getElementById('payment-amount').textContent = vip.price;
            document.getElementById('display-amount').textContent = vip.price;
        }

        // 支付倒计时
        function startTimer() {
            let timeLeft = 15 * 60; // 15分钟
            const timerElement = document.getElementById('timer');
            
            const timer = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.textContent = `支付剩余时间: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    timerElement.textContent = '支付已超时，请重新生成订单';
                }
                timeLeft--;
            }, 1000);
        }

        // 激活VIP
        function activateVip(type, paymentMethod = 'qrcode') {
            const vip = vipTypes[type];
            const deviceId = generateDeviceId();
            const expiryTime = Date.now() + (vip.expiryHours * 60 * 60 * 1000);
            
            // 保存VIP信息
            localStorage.setItem('vip_device_id', deviceId);
            localStorage.setItem('vip_expiry', expiryTime);
            localStorage.setItem('vip_active', 'true');
            localStorage.setItem('vip_type', type);
            
            // 创建订单数据
            const orderData = {
                order_number: document.getElementById('order-number').textContent,
                device_id: deviceId,
                vip_type: type,
                product_name: vip.name,
                price: vip.price,
                duration: vip.duration,
                expiry_time: expiryTime,
                payment_status: paymentMethod === 'trial' ? 'trial' : 'success',
                payment_method: paymentMethod,
                create_time: new Date().toISOString(),
                update_time: new Date().toISOString()
            };
            
            // 保存订单到数据库
            saveOrderToD1(orderData);
            
            // 跳转到服务页面
            setTimeout(() => {
                window.location.href = 'service.html';
            }, 1000);
        }

        // 页面初始化
        document.addEventListener("DOMContentLoaded", function() {
            // 生成设备ID和订单号
            const deviceId = generateDeviceId();
            const orderNumber = generateOrderNumber();
            
            document.getElementById('device-id').textContent = deviceId;
            document.getElementById('order-number').textContent = orderNumber;
            
            // 从本地存储恢复订单号
            const savedOrderNum = localStorage.getItem('currentOrderNum');
            if (savedOrderNum) {
                currentOrderNum = parseInt(savedOrderNum);
            }
            
            // 默认选择日卡
            selectVipType('daily');
            
            // 启动支付倒计时
            startTimer();
            
            // 模拟支付成功
            document.getElementById('simulatePaymentBtn').addEventListener('click', function() {
                activateVip(selectedVipType, 'qrcode');
            });
            
            // 稍后支付，我先试试
            document.getElementById('simulateFailureBtn').addEventListener('click', function() {
                activateVip(selectedVipType, 'trial');
            });
        });
    </script>
</body>
</html>